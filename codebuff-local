#!/bin/bash
# Run codebuff CLI against self-hosted backend or cloud
# Can be symlinked to /usr/local/bin and run from any directory
#
# Usage:
#   codebuff-local              # Uses local backend (localhost:9999)
#   codebuff-local --cloud      # Uses cloud backend (codebuff.com)
#   CODEBUFF_USE_CLOUD=1 codebuff-local  # Uses cloud backend via env var

# Capture the original working directory before any cd
ORIGINAL_CWD="$(pwd)"

# Resolve the actual script location (follows symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  # If $SOURCE is relative, resolve it relative to symlink directory
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Check for --cloud flag
USE_CLOUD="${CODEBUFF_USE_CLOUD:-}"
ARGS=()
for arg in "$@"; do
  if [ "$arg" = "--cloud" ]; then
    USE_CLOUD=1
  else
    ARGS+=("$arg")
  fi
done

# Common environment variables
COMMON_ENV=(
  "LOG_LEVEL=debug"
  "NEXT_PUBLIC_SUPPORT_EMAIL=support@example.com"
  "NEXT_PUBLIC_POSTHOG_API_KEY=dummy"
  "NEXT_PUBLIC_POSTHOG_HOST_URL=https://us.i.posthog.com"
  "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_dummy"
  "NEXT_PUBLIC_STRIPE_CUSTOMER_PORTAL=https://billing.stripe.com/p/login/dummy"
)

if [ -n "$USE_CLOUD" ]; then
  # Cloud mode: use codebuff.com
  echo "üåê Running in CLOUD mode (codebuff.com)"
  MODE_ENV=(
    "NEXT_PUBLIC_CODEBUFF_APP_URL=https://codebuff.com"
    "NEXT_PUBLIC_CB_ENVIRONMENT=prod"
    "NEXT_PUBLIC_WEB_PORT=3000"
  )
else
  # Local mode: use localhost
  echo "üè† Running in LOCAL mode (localhost:9999)"
  MODE_ENV=(
    "NEXT_PUBLIC_CODEBUFF_APP_URL=http://localhost:9999"
    "NEXT_PUBLIC_CB_ENVIRONMENT=dev"
    "NEXT_PUBLIC_WEB_PORT=9999"
  )
fi

cd "$SCRIPT_DIR/cli"
# Use env command to ensure our variables take precedence over .env files
exec env "${COMMON_ENV[@]}" "${MODE_ENV[@]}" bun run src/index.tsx --cwd "$ORIGINAL_CWD" -- "${ARGS[@]}"
